name: ğŸ¤– AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

jobs:
  ai-review:
    name: AI-Powered Code Review
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Install additional dependencies for image processing
          pip install opencv-python-headless pytesseract pillow
          
          # Install Tesseract OCR
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-vie
      
      - name: ğŸ”§ Verify Installation
        run: |
          python -c "from src.web.main import app; print('âœ… FastAPI app loaded')"
          python -c "from src.agents.image_agent import ImageAgent; print('âœ… ImageAgent loaded')"
          python -c "import pytesseract; print('âœ… Tesseract OCR ready')"
          python -c "import cv2; print('âœ… OpenCV ready')"
      
      - name: ğŸ¤– Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "ğŸš€ Starting AI Code Review..."
          echo "ğŸ“‹ PR Info:"
          echo "  Repository: $GITHUB_REPOSITORY"
          echo "  PR Number: $PR_NUMBER"
          echo "  Title: $PR_TITLE"
          echo "  Author: $PR_AUTHOR"
          echo "  Branch: $PR_BRANCH -> $BASE_BRANCH"
          echo ""
          
          # Run the AI review script
          python scripts/ai_review.py
      
      - name: ğŸ“Š Review Summary
        if: always()
        run: |
          echo "## ğŸ¤– AI Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ PR Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number:** ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ Analysis Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Agents:** GitHubIssueAgent, CodeAgent, DocumentationAgent" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-modal:** âœ… Image processing enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Integration:** âœ… Context-aware analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This review was powered by GitHub AI Agent - Phase 5*" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ¯ Success Notification
        if: success()
        run: |
          echo "âœ… AI Code Review completed successfully!"
          echo "ğŸ“ Check the PR comments for detailed analysis."
      
      - name: âŒ Error Notification
        if: failure()
        run: |
          echo "âŒ AI Code Review failed!"
          echo "ğŸ” Check the logs above for details."
          echo "ğŸ“ Contact the repository maintainers if needed."

  # Optional: Run on schedule for health checks
  health-check:
    name: ğŸ¥ System Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ” Health Check
        run: |
          python -c "
          from src.agents.agent_manager import AgentManager
          from src.agents.github_issue_agent import GitHubIssueAgent
          from src.agents.code_agent import CodeAgent
          from src.agents.doc_agent import DocumentationAgent
          from src.agents.image_agent import ImageAgent
          
          print('âœ… All agents initialized successfully')
          print('âœ… Phase 5 multi-modal system ready')
          "
